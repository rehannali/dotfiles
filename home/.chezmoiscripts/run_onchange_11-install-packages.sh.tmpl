#!/usr/bin/env bash
set -euo pipefail

DEST_DIR="{{ .chezmoi.destDir }}"
[[ -f "$DEST_DIR/.local/lib/chezmoi-utils.sh" ]] && . "$DEST_DIR/.local/lib/chezmoi-utils.sh"

info "chezmoi: render Brewfile and run brew bundle (global -> darwin -> darwin_arm) for {{ .chezmoi.os }}/{{ .chezmoi.arch }}"

run brew bundle -v --file=/dev/stdin <<'BrewfileEOF'
{{- $p := .packages -}}

{{- if hasKey $p "taps" -}}
{{- range $p.taps -}}
{{ printf "\ntap %q\n" . -}}
{{- end -}}
{{- end -}}

{{- if hasKey $p "global" -}}
  {{- if hasKey $p.global "brews" -}}
    {{- range $p.global.brews -}}
      {{- $b := . -}}
      {{- if hasKey $b "name" -}}
        {{- if hasKey $b "args_str" -}}
{{ printf "\nbrew %q, %s\n" (index $b "name") (index $b "args_str") -}}
        {{- else -}}
{{ printf "\nbrew %q\n" (index $b "name") -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- if eq .chezmoi.os "darwin" -}}
  {{- if hasKey $p "darwin" -}}

    {{- if hasKey $p.darwin "brews" -}}
      {{- range $p.darwin.brews -}}
        {{- $b := . -}}
        {{- if hasKey $b "name" -}}
          {{- if hasKey $b "args_str" -}}
{{ printf "\nbrew %q, %s\n" (index $b "name") (index $b "args_str") -}}
          {{- else -}}
{{ printf "\nbrew %q\n" (index $b "name") -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}

    {{- if hasKey $p.darwin "casks" -}}
      {{- range $p.darwin.casks -}}
        {{- $c := . -}}
        {{- if hasKey $c "name" -}}
          {{- if hasKey $c "args_str" -}}
{{ printf "\ncask %q, %s\n" (index $c "name") (index $c "args_str") -}}
          {{- else -}}
{{ printf "\ncask %q\n" (index $c "name") -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}

    {{- if hasKey $p.darwin "mas" -}}
      {{- range $p.darwin.mas -}}
        {{- $m := . -}}
        {{- if and (hasKey $m "name") (hasKey $m "id") -}}
{{ printf "\nmas %q, id: %v\n" (index $m "name") (index $m "id") -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}

  {{- end -}}
{{- end -}}

{{- if and (eq .chezmoi.os "darwin") (or (eq .chezmoi.arch "arm64") (eq .chezmoi.arch "arm")) -}}
  {{- if hasKey $p "darwin_arm" -}}

    {{- if hasKey $p.darwin_arm "brews" -}}
      {{- range $p.darwin_arm.brews -}}
        {{- $b := . -}}
        {{- if hasKey $b "name" -}}
          {{- if hasKey $b "args_str" -}}
{{ printf "\nbrew %q, %s\n" (index $b "name") (index $b "args_str") -}}
          {{- else -}}
{{ printf "\nbrew %q\n" (index $b "name") -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}

    {{- if hasKey $p.darwin_arm "casks" -}}
      {{- range $p.darwin_arm.casks -}}
        {{- $c := . -}}
        {{- if hasKey $c "name" -}}
          {{- if hasKey $c "args_str" -}}
{{ printf "\ncask %q, %s\n" (index $c "name") (index $c "args_str") -}}
          {{- else -}}
{{ printf "\ncask %q\n" (index $c "name") -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}

    {{- if hasKey $p.darwin_arm "mas" -}}
      {{- range $p.darwin_arm.mas -}}
        {{- $m := . -}}
        {{- if and (hasKey $m "name") (hasKey $m "id") -}}
{{ printf "\nmas %q, id: %v\n" (index $m "name") (index $m "id") -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}

  {{- end -}}
{{- end -}}

{{- if eq .chezmoi.os "linux" -}}
{{- end -}}
BrewfileEOF

info "Brew update"
run brew update

info "Brew upgrade"
run brew upgrade

info "Brew upgrade --cask"
run brew upgrade --cask

info "Brew cleanup"
run brew cleanup && rm -rf "$(brew --cache)"